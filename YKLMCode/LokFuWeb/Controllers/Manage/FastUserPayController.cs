using LokFu.Extensions;
using LokFu.FastPay;
using LokFu.Infrastructure;
using LokFu.Models;
using LokFu.Repositories;
using LokFu.Repositories.SqlServer;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web.Mvc;
namespace LokFu.Areas.Manage.Controllers
{
    /// <summary>
    /// 收付直通车-商户通道管理
    /// </summary>
    public class FastUserPayController : BaseController
    {
        public ActionResult Index(FastUserPay FastUserPay, EFPagingInfo<FastUserPay> p, DateTime? STime, DateTime? ETime, int IsFirst = 0)
        {
            #region 筛选条件
            if (!FastUserPay.MerId.IsNullOrEmpty())
            {
                switch (FastUserPay.Bin)
                {
                    case "1":
                        var ids = this.Entity.Users.Where(o => o.TrueName.Contains(FastUserPay.MerId)).Select(o => o.Id).ToList();
                        p.SqlWhere.Add(f => ids.Contains(f.UId));
                        break;
                    case "2":
                        var uid = this.Entity.Users.Where(o => o.UserName.Contains(FastUserPay.MerId)).Select(o => o.Id).ToList();
                        p.SqlWhere.Add(f => uid.Contains(f.UId));
                        break;
                }
            }
            if (!FastUserPay.MerState.IsNullOrEmpty())
            {
                var MerState = FastUserPay.MerState == 99 ? 0 : FastUserPay.MerState;
                p.SqlWhere.Add(f => f.MerState == MerState);
            }
            if (!FastUserPay.CardState.IsNullOrEmpty())
            {
                var CardState = FastUserPay.CardState == 99 ? 0 : FastUserPay.CardState;
                p.SqlWhere.Add(f => f.CardState == CardState);
            }
            if (!FastUserPay.BusiState.IsNullOrEmpty())
            {
                p.SqlWhere.Add(f => f.BusiState == FastUserPay.BusiState);
            }
            if (!FastUserPay.PayWay.IsNullOrEmpty())
            {
                p.SqlWhere.Add(f => f.PayWay == FastUserPay.PayWay);
            }
            if (STime.HasValue)
            {
                p.SqlWhere.Add(f => f.AddTime >= STime);
            }
            if (ETime.HasValue)
            {
                p.SqlWhere.Add(f => f.AddTime <= ETime);
            }
            #endregion
            p.OrderByList.Add("Id", "DESC");
            IPageOfItems<FastUserPay> FastUserPayList = null;
            if (IsFirst == 0)
            {
                FastUserPayList = new PageOfItems<FastUserPay>(new List<FastUserPay>(), 0, 10, 0, new Hashtable());
            }
            else
            {
                FastUserPayList = Entity.Selects<FastUserPay>(p);
            }
            var uids = FastUserPayList.Select(o => o.UId).ToList();
            var UsersList = this.Entity.Users.Where(o => uids.Contains(o.Id)).ToList();
            var FastPayWayList = this.Entity.FastPayWay.ToList();
            ViewBag.FastPayWayList = FastPayWayList;
            ViewBag.UsersList = UsersList;
            ViewBag.FastUserPayList = FastUserPayList;
            ViewBag.FastUserPay = FastUserPay;
            ViewBag.STime = STime;
            ViewBag.ETime = ETime;

            return View();
        }

        /// <summary>
        /// 通道查询
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        [HttpGet]
        public ActionResult ChannelQuery(int id)
        {
            ChannelDateModel ChannelDateModel = new ChannelDateModel();
            var FastUserPay = this.Entity.FastUserPay.FirstOrDefault(o => o.Id == id);
            if (FastUserPay == null)
            {
                ViewBag.ErrorMsg = "数据不存在";
                return View("Error");
            }
            var FastPayWay = this.Entity.FastPayWay.FirstOrDefault(o => o.Id == FastUserPay.PayWay);
            if (FastPayWay == null)
            {
                ViewBag.ErrorMsg = "接口数据不存在";
                return View("Error");
            }
            string[] PayConfigArr = FastPayWay.QueryArray.Split(',');
            if (FastPayWay.DllName == "HFPay")
            {
                ViewBag.ErrorMsg = "本接口不需要进件商户";
                return View("Error");
            }
            else if (FastPayWay.DllName == "HFJSPay")
            {
                ViewBag.ErrorMsg = "本接口不支持查询商户信息";
                return View("Error");
            }
            else
            {
                ViewBag.ErrorMsg = "没有适配的接口";
                return View("Error");
            }
            ViewBag.FastUserPay = FastUserPay;
            ViewBag.FastPayWay = FastPayWay;
            ViewBag.ChannelDateModel = ChannelDateModel;
            return this.View();
        }
        
        #region 批量通道查询
        //    public FastUserPayController()
    //    {
    //        ViewBag.Authorization = true;//允许权限
    //    }
    //    public FileResult Test()
    //    {
    //        List<string> dd = new List<string>()
    //        {
    //            "13533628055","13897338200","18629475747","13590143181","15172823458","18005936222","18013898980","18131066611","18650525311","13526806829","18257404400","18080467106","15959927525","13019054610","13972550591","15850727537","13587796727","18020265826","15617631963","13335971010","15223602603","15938148831","15545860008","18915508234","18103730978","18638669249","18742466111","13507540700","15836181734","18516681458","13568899498","15528059896","13689572852","15003876058","13766419031","13907837460","13026673828","15093352025","18982419182","15185241102","13487071749","13911233042","15038114108","18995140007","13351422020","13868485828","15516466688","18280070593","18635147484","13538257654","18627749553","13569412413","13845911642","18020151343","13487296137","18391699983","15960250325","18537915000","18611869895","18468220709","18925489489","15809911172","15160103681","13579892915","18072121618","18020311085","15367129231","15838288609","15905529989","13850353033","18209208210","15707668251","13849990029","15280879333","13986794168","13606897092","18650365186","18639337225","13271191488","13587727880","13566090940","15888971206","15953468176","15915453916","15511730326","13121046089","15959294008","13883068117","18960152559","15807559947","15867115952","13456777070","13635270979","13016618798","15896179458","15091907660","13735758286","15972716312","15665405828","15937258451","13799655622","13349491043","13631513772","18172941600","13709282554","18002449827","15102940056","15010973013","15568259258","13845376627","13320213565","15521326501","18853706090","15890165745","18267441116","13680779720","15617903567","18523734367","18147116095","18801307052","15093178455","18318305690","18943685206","15033158820","13354925603","18657768988","13952578152","15617786883","18658904980","15207403302","13384612340","18028754199","13725043166","18703683501","13673672290","15620988856","18538793979","13859036617","13524922824","15032208738","18678868988","13711616768","13480905780","13009888311","15618336961","13185867088","15012728834","18905760318","13587755751","18606092502","18559375597","13926671017","13810011868","18505933588","13006635056","15538963197","15225156528","13860315382","18503000719","15671068338","13850308170","15971662191","15668367596","13937138842","15262483560","13758783402","15082066625","13430836103","13760253152","15913196533","13205932201","13236258488","18606065786","18734367752","18611315779","15657972790","13386360456","13799806385","15373905510","13802417508","15897970773","13961703341","15907635735","15046669593","18839510862","15878180606","15010227595","13850070987","18115545767","13858404561","13953467500","13806795597","15178248777","18601078777","15169199398","13465315115","13103579382","15054729685","18659559525","13323860522","15559182227","13810976589","13158942655","15896660006","18874062034","18066819216","13670007341","13603602520","18983226866","13665934064","13484225836","13320260623","18434556666","18855158872","18605487300","13777715996","18634573141","18516285158","13915460777","13813577197","13078093007","18149497809","13960635370","13989764000","18551581576","13927458027","13314508551","15888979111","15806024276","18823660411","15738867977","18950808209","13868692824","13370668268","15129477267","18536667703","15057592121","18663770208","13930116101","18851260614","18736071631","15914050558","13528801869","15013899386","15333719357","18203639597","13917850726","13824423598","13333846540","13040890678","15717928000","13515518028","13706688646","18786082617","15937892233","13849170401","15833218353","15995130265","18737170806","13858565077","13691657912","13887494567","13810645472","13620887699","18629018853","13366752012","18511029151","13879002444","13839836290","18617261968","13572018333","15302000037","18956080820","18134353687","18927233990","18696556627","18257116082","15022962109","18603101948","13823376436","13793446480","13570963890","15538198583","13409417951","18001226263","13856102820","18607898985","18639005897","15980217037","15587779157","18816825102","13506839422","18159328328","15022071787","18960698755","18625550961","15171866608","15915171123","18538330888","15046337512","18137193199","18607102788","15989353325","13327179952","13960678113","18680800182","15769158777","13883099936","13703026811","13849592678","13849878996","13500162558","15287301744","13523542242","18370103690","18663510558","13513316822","13512715129","15876815616","13868590660","18256534888","18037101235","18962661139","18612916959","15201112145","13703925825","18043224429","13140591434","15210670726","13810149800","13802246060","13670021996","13732171766","18600331818","13838991371","15924225032","18385364157","15505167775","13992003803","18602902009","18605089293","13522597526","18939127231","13590337821","13751008685","18637790367","13978605912","18092413630","13855511224","15929300930","13375531567","13957353927","18952680777","13691616747","18566768535","13500269427","13266186000","13828598855","13572805507","15059337739","13599063520","18848858367","15515884577","15259350001","18695909102","13712692890","13860374030","18871152955","18530959533","15713866067","13403209550","15857565566","13758932639","15896811553","13978815227","13860333098","13646009059","18011976677","13405646399","13201517000","15919482065","18004722617","15133141385","13553344987","15130205057","15826057278","18537129803","18820695106","18550222784","18969002893","13055833488","18368369712","13831577416","13386388388","18692734849","15159973797","15935728128","18151306799","15263326763","15535691389","18138005705","13760825002","13506192043","18562201663","13245833313","18026078355","15776892268","13951663961","13548642895","13667413800","15886448252","13628351008","15112612005","13488356087","13349767644","13886662112","13607336529","18749037800","18667876666","15817451516","13949131107","18996223292","13652239000","13926154515","13981856445","13572854767","13487253309","13501830681","13566171206","18960036555","15801322056","13566260182","18874848272","13840428752","15250069995","15838278225","18859768601","15344484777","13424218486","18590931818","15560252988","15261652953","13307586677","13029534588","15306211523","18005095777","18781258888","13958829079","15318500111","13545754668","13759549909","18229077766","15955868816","18683012700","13751528682","18866961298","18137869316","13814432412","15112470505","15378777536","13700938686","13935479788","18978065806","13605419775","13308347115","18172868383","13049427975","13923730685","13801298319","13709225797","15578372630","15888356635","18723569638","15902944646","15343345800","18706170010","15967590026","15683590091","15637050685","15587157228","18685447573","18501609911","18729297680","13313489301","18031859139","18565592037","13205754606","13938828486","13203471762","15190311972","15515667286","15291195297","18908440902","15260858919","13707392983","13984987755","15243224545","18672092220","18005055785","15372800777","13802272967","15914068465","18914911889","18580046768","13140014134","15806863028","15001122688","18045333339","18972518268","13320742548","15837196684","13636897532","13695987978","18673055153","13276906181","13356133180","18503008290","13838231903","15937166768","13858943533","13320295056","18520825505","15861877607","13647619527","18503854906","13422890885","15122327262","15258302065","18965175433","18950669217","15929960006","18859856508","18778030007","13903759972","15000777414","13928518513","15058333168","13577475058","13610090504","15355500011","18505958185","18823491199","13173680775","18664959605","15903661180","13027529566","15913252311","18605130102","13851175377","18239796070","18766570799","13590831288","13469826565","15938792343","13592243626","18972477277","13027511880","15375969993","18291836205","18945625522","18307091025","13689565008","13235020390","13997661730","13709352623","15017580976","18948755511","13825200684","13570204455","13587588987","13103868925","13814271643","15945199398","15048826606","13233399870","13867794444","18606607261","13572910322","15059388398","18170809191","15736060399","15088975587","18790536663","13852738881","13783447654","13958898817","18621630625","13132847566","13514060852","18058987153","13977281530","18977481112","15659732010","15037188930","13776209122","18877200835","13950979745","13839133530","13832106705","18539979452","15952107199","15810196174","18733325067","13602316505","13082804941","18508525500","15957988463","15013732205","13760310061","13301091980","18626242454","18521508830","13083454198","15225029228","18286047918","18612613106","13412509457","13633563354","18603759711","15065553568","13718387137","15161812797","13477258231","13844884243","13383992658","15260123331","15931828516","13913510656","15919849226","13423512211","15861553837","18538500567","13123236660","13509588382","15360606757","15069076181","13923418841","18559365336","15161806777","13991935536","15605992999","13937365981","13714199662","15666915888","13507629220","13840307340","13178023549","13614414490","18588804518","13799290976","15355275678","15587162179","13468985789","18716368388","15144797587","13644827373","15243628553","18807712980","18945302345","18893188866","13513093222","15501530293","15093390933","15062578960","18235051152","18627934103","13349398170","13983376300","13003941118","15050318669","18605063158","15037162810","18554631868","15160780058","15143222279","13572103966","13584879709","13182306173","13879297354","18179708826","15608045555","13410358685","15202903006","13735059750","15952038022","15910982001","13960355391","13516657521","13829739941","15801435185","18235736646","15090688631","18647208066","18539165619","15800039488","15536701501","15297950080","18940884595","13450472121","18135916655","15638552283","15537529052","13691952021","15139218388","15524557766","13902630304","13850630726","15991710233","18625155880","18537108939","13592699377","13575644724","18825052836","15136868350","18032050618","15866231588","13808804139","18620057037","15971862558","18675592829","13380336101","13658670198","13011720990","18746525171","18511894633","18961845412","13333999551","15820488483","15988798884","15238002996","18934593618","13810708598","15818582083","18653358705","13727171027","13120226666","13761719727","18576776646","18820255393","18537105575","13991134375","18642698215","18696623886","18137827106","13321970584","13690530013","18027676777","15136159097","13559110311","18738909555","18178269899","13531376001","15248069859","18625566796","18631887611","18927781126","13424157372","13346217018","18635166593","13782536066","15847125992","15220142336","13910017000","13601209483","18301464290","18950852383","13585006632","18850227720","18691485028","15237120334","18685200927","13566750531","15925945187","18503496189","13695232587","15904533710","13820638028","13452341773","15202138421","13006628310","13339792250","13972567215","18065162483","13516673115","13475469460","13682586847","13914155557","18451790299","18112415099","13791669968","13784848080","18158302999","13862038594","18961886688","18759511213","13871791770","13619206429","15010429425","13909041297","15216170828","18650968509","13353386008","13677606860","13375878008","18691076214","18872296049","18351626022","15041182742","13580574585","13850816479","13510471158","13421821821","13771626437","13959329468","13077375444","13032748661","15860687555","13953595455","15820493187","13682781091","18681151673","18982456149","18967930658","13824448588","13926444598","15520626282","18967671757","15849183766","13382275521","13949143323","18523266622","15071860070","13513375247","15072633338","13592483609","15828114665","13926668430","18742233536","18906579110","13129992038","15008564724","15626428405","13750990777","13113335083","15915483297","15003821691","15609238757","18685255355","18003712866","18537111727","18322801915","15318307873","18966912138","15155803688","18770000586","15963106118","18531363897","15050338335","18927490911","13926487110","15559655806","15838028123","15838811835","15673989609","13707206282","18091265410","13641427409","13405771536","15323128877","13226593355","18239037076","15637887955","18910771601","13872633476","15045869978","15099097595","13983080886","18815018538","18523853290","15869698787","15709156922","15670004222","13003803368","15200366537","15999956080","13674736656","15540880803","15936258018","18091014111","13353088087","13759964404","13925993704","15288398628","13902851702","13103724043","18567600755","15516199909","13717036777","15859357642","18350861222","18747540733","13655553200","18815958655","13437775523","13851617045","13939596987","13836307677","13690500007","18213976515","18657675310","15198971200","18758774534","13691229602","13849098268","18906652226","13928957027","13858193354","18567259691","13381176747","13674742007","18037471214","13583070009","15839875161","18790597198","13539381960","18696694120","18038891666","13526736831","18273486961","15818080830","15370092833","13137133352","15881269115","18790256981","18591776872","18678890717","15088807971","13392188897","15960028702","13952111166","13632927750","13968273080","18292771600","13513297198","13721687360","18053111522","15166337333","15515566854","13432174219","13078884228","13809179653","18028662082","13510023098","13777736207","15834195222","18020308289","13509537350","15888289933","13854865512","18306178400","13926256678","15171902949","13400012951","13632675796","18339255805","13013552710","13566631593","15860063326","18088438242","15765568059","13244519879","13922966855","15176107015","18968882755","15325982278","15565066685","18702352558","15174925224","15729263028","15639930355","13859350604","13526029757","13115628789","18962287562","15074954508","13528920731","15088787547","13950836152","15846783555","13535315466","13526387056","18026636030","13911114351","13450545689","15273005557","15365421880","13414896880","15722088243","13616821877","13341389382","15238686943","13392888669","18388068306","13809149626","18306672542","18287404542","13503717408","13954344084","15173399168","18369187335","15545300567","15208956001","15664220708","15238281836","15012959686","18577831018","15835254321","13244730819","18103820838","18074471987","13798440528","13588990091","13828806151","15045286443","15279507272","15914120257","15327664966","13967718987","13227790057","13511026525","18995888398","13860325228","18037138020","13592554208","13872599177","13715298914","13961646026","18660787858","15259693655","13002405588","13633477557","15303711051","18605968694","13937924111","13588977861","18600603093","13973394224","13826550195","13083791501","15093470784","18608602101","18635270426","15823451579","13811436988","13954389378","13810561018","15930901761","18539408825","13671739238","13622822019","15829614989","18559866600","13825523729","15359910008","18095002852","15899274247","13832009908","13021645156","13770033766","18733484777","18867661259","18649708878","13541933004","18539776285","15005220389","18908135850","13153604625","18937198192","18605625552","13819421344","13140143094","15137139728","15546306603","18946011351","13790607386","13963268653","13953229925","13569872452","18910771665","13972802756","18551380175","18503847828","13852031780","18838262653","13567792292","13203898680","15005220239","15159092855","13783882268","15962621975","13872569981","15872486777","15960015624","13685599911","18771870153","13823638626","18058305550","18565626631","13589963663","18158335333","13474263598","15817465326","18757777087","13128200188","18762818190","18687178879","13257259098","13359189264","15872571886","13838045243","15167767700","13395183838","15162445942","15098811817","13332811600","13510015050","15932105622","13913088789","15968488522","18571638819","13457198382","13505393736","15056008855","18616283458","18666697923","13527335399","18125090732","15685976366","15266994871","13306138800","18857458998","15095129936","15888929333","13076500707","13862244955","18027559555","15565172516","18996168725","15136856000","13002575812","18765319578","18688022020","15537203337","15532371421","18695892062","13501677724","13535590689","15135362661","13396525508","18971313645","13802507951","18788274572","18218088916","13760702737","15815686314","18943106771","18070039188","15242208275","15832921702","13526833667","18538180190","15291003635","18690734639","15872656661","18512552699","13526797715","13487298785","15516181003","18249457288","18061460016","13015333173","13509522040"
    //        };
    //        List<ChannelDateModel> ChannelDateModelList = new List<ChannelDateModel>();
    //        var FastPayWay = this.Entity.FastPayWay.FirstOrDefault(o => o.Id == 1);
    //        string[] PayConfigArr = FastPayWay.QueryArray.Split(',');
    //        if (PayConfigArr.Length == 3)
    //        {
    //            string agencyId = PayConfigArr[0];//机构号
    //            foreach(var item in dd)
    //            {
    //                GHTPay GHTPay = new GHTPay();
    //                Dictionary<string, string> AuthInfo = GHTPay.AuthInfo(item, agencyId);
    //                Dictionary<string, string> AuthMoney = GHTPay.AuthMoney(item, agencyId);
    //                var ChannelDateModel = new ChannelDateModel()
    //                {
    //                    MerchantId = AuthInfo.FirstOrNew(o => o.Key == "merchantId").Value,
    //                    Name = AuthInfo.FirstOrNew(o => o.Key == "name").Value,
    //                    CertNo = AuthInfo.FirstOrNew(o => o.Key == "certNo").Value,
    //                    BankAccountNo = AuthInfo.FirstOrNew(o => o.Key == "bankaccountNo").Value,
    //                    AuthResult = AuthInfo.FirstOrNew(o => o.Key == "authResult").Value,
    //                    BalanceAmount = AuthMoney.FirstOrNew(o => o.Key == "balanceAmount").Value,
    //                    FreezeAmount = AuthMoney.FirstOrNew(o => o.Key == "freezeAmount").Value,
    //                };
    //                ChannelDateModelList.Add(ChannelDateModel);
    //            }
                
    //        }
    //        DataTable table = new DataTable();
    //        DataRow row = null;

    //        // 创建 datatable
    //        table.Columns.Add(new DataColumn("商户号", typeof(string)));
    //        table.Columns.Add(new DataColumn("持卡人姓名", typeof(string)));
    //        table.Columns.Add(new DataColumn("持卡人证件号", typeof(string)));
    //        table.Columns.Add(new DataColumn("银行卡号", typeof(string)));
    //        table.Columns.Add(new DataColumn("入驻结果", typeof(string)));
    //        table.Columns.Add(new DataColumn("可用余额", typeof(string)));
    //        table.Columns.Add(new DataColumn("冻结金额", typeof(string)));

    //        // 填充数据
    //        foreach (var item in ChannelDateModelList)
    //        {
    //            row = table.NewRow();
    //            row[0] = item.MerchantId;
    //            row[1] = item.Name;
    //            row[2] = item.CertNo;
    //            row[3] = item.BankAccountNo;
    //            row[4] = item.AuthResult;
    //            row[5] = item.BalanceAmount;
    //            row[6] = item.FreezeAmount;
    //            table.Rows.Add(row);
    //        }

    //        return this.ExportExcelBase(table, "hehe");
        //    }
        #endregion
    }

    public class ChannelDateModel
    {
        /// <summary>
        /// 商户号[手机]
        /// </summary>
        public string MerchantId { get; set; }
        /// <summary>
        /// 持卡人姓名
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// 持卡人证件号
        /// </summary>
        public string CertNo { get; set; }
        /// <summary>
        /// 银行卡号
        /// </summary>
        public string BankAccountNo { get; set; }
        /// <summary>
        /// 入驻结果
        /// </summary>
        public string AuthResult { get; set; }
        /// <summary>
        /// 可用余额
        /// </summary>
        public string BalanceAmount { get; set; }
        /// <summary>
        /// 冻结金额
        /// </summary>
        public string FreezeAmount { get; set; }
    }
}
